<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeCritter Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        background-color: transparent;
        color: var(--vscode-editor-foreground);
        font-family: var(--vscode-font-family);
      }
      .review-card {
        border-left: 4px solid #4f46e5;
      }
      .blinking-cursor {
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        50% {
          border-right-color: var(--vscode-editor-foreground);
        }
      }
      .toggle-switch {
        position: relative;
        width: 50px;
        height: 24px;
        background-color: #374151;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .toggle-switch.active {
        background-color: #4f46e5;
      }
      .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
      }
      .toggle-switch.active .toggle-slider {
        transform: translateX(26px);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script>
      const vscode = acquireVsCodeApi();
    </script>

    <script type="text/babel">
      const Header = () => (
        <header className="text-center">
          <h1 className="text-2xl font-bold">CodeCritter</h1>
          <p className="text-sm text-gray-400">Your AI Code Review Companion</p>
        </header>
      );

      const AutoReviewSection = ({ 
        autoReviewEnabled, 
        setAutoReviewEnabled, 
        reviewThreshold, 
        setReviewThreshold,
        commitAssistEnabled,
        setCommitAssistEnabled,
        handleSaveSettings 
      }) => {
        const [isOpen, setIsOpen] = React.useState(false);
        
        return (
          <div className="pt-4 border-t border-gray-700">
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="w-full text-left font-semibold text-lg hover:text-indigo-400 transition-colors"
            >
              Auto Review Settings {isOpen ? "‚ñ≤" : "‚ñº"}
            </button>
            {isOpen && (
              <div className="mt-4 p-4 bg-gray-800 rounded-md space-y-4">
                <p className="text-sm text-gray-400">
                  Configure CodeCritter's automated review behavior. Auto review analyzes your code automatically when you save files.
                </p>
                
                {/* Auto Review Toggle */}
                <div className="flex items-center justify-between">
                  <div>
                    <label className="block text-sm font-medium">Auto Review</label>
                    <p className="text-xs text-gray-400">Automatically review code when files are saved</p>
                  </div>
                  <div 
                    className={`toggle-switch ${autoReviewEnabled ? 'active' : ''}`}
                    onClick={() => setAutoReviewEnabled(!autoReviewEnabled)}
                  >
                    <div className="toggle-slider"></div>
                  </div>
                </div>

                {/* Commit Assistant Toggle */}
                <div className="flex items-center justify-between">
                  <div>
                    <label className="block text-sm font-medium">Commit Assistant</label>
                    <p className="text-xs text-gray-400">Suggest commit messages when changes are ready</p>
                  </div>
                  <div 
                    className={`toggle-switch ${commitAssistEnabled ? 'active' : ''}`}
                    onClick={() => setCommitAssistEnabled(!commitAssistEnabled)}
                  >
                    <div className="toggle-slider"></div>
                  </div>
                </div>

                {/* Review Threshold */}
                <div className="space-y-2">
                  <label htmlFor="reviewThreshold" className="block text-sm font-medium">
                    Notification Threshold
                  </label>
                  <select
                    id="reviewThreshold"
                    className="w-full p-2 border border-gray-600 rounded-md bg-gray-900 text-gray-200"
                    value={reviewThreshold}
                    onChange={(e) => setReviewThreshold(e.target.value)}
                  >
                    <option value="low">Low - Show all reviews</option>
                    <option value="medium">Medium - Show moderate+ issues</option>
                    <option value="high">High - Show only severe issues</option>
                  </select>
                  <p className="text-xs text-gray-400">
                    Controls when you get notified about code reviews
                  </p>
                </div>

                <button
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md"
                  onClick={handleSaveSettings}
                >
                  Save Auto Review Settings
                </button>
              </div>
            )}
          </div>
        );
      };

      const SettingsSection = ({ apiKey, setApiKey, handleSaveKey }) => {
        const [isOpen, setIsOpen] = React.useState(false);
        return (
          <div className="pt-4 border-t border-gray-700">
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="w-full text-left font-semibold text-lg hover:text-indigo-400 transition-colors"
            >
              API Settings {isOpen ? "‚ñ≤" : "‚ñº"}
            </button>
            {isOpen && (
              <div className="mt-4 p-4 bg-gray-800 rounded-md space-y-3">
                <p className="text-sm text-gray-400">
                  To avoid rate limits and ensure consistent access, you can
                  provide your own Google AI API key. CodeCritter will store this
                  securely in your local VS Code settings.
                </p>
                <div>
                  <label
                    htmlFor="apiKeyInput"
                    className="block text-sm font-medium mb-1"
                  >
                    Your Gemini API Key
                  </label>
                  <div className="flex space-x-2">
                    <input
                      type="password"
                      id="apiKeyInput"
                      className="flex-grow p-2 border border-gray-600 rounded-md bg-gray-900 text-gray-200"
                      placeholder="Enter your API key"
                      value={apiKey}
                      onChange={(e) => setApiKey(e.target.value)}
                    />
                    <button
                      className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md"
                      onClick={handleSaveKey}
                    >
                      Save
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      const CodeInput = ({ code, setCode, isLoading }) => (
        <div className="space-y-2">
          <label htmlFor="codeInput" className="block text-sm font-medium">
            Paste Your Code Snippet
          </label>
          <textarea
            id="codeInput"
            rows="10"
            className="w-full p-2 border border-gray-600 rounded-md bg-gray-800 text-gray-200 font-mono text-sm"
            placeholder="function hello() { ... }"
            value={code}
            onChange={(e) => setCode(e.target.value)}
            disabled={isLoading}
          ></textarea>
          <p className="text-xs text-gray-400">
            üí° Tip: Auto review is active! Just save your files to get automatic code analysis.
          </p>
        </div>
      );

      const ReviewSection = ({ review }) => (
        <div className="space-y-4 pt-4 border-t border-gray-700">
          <h2 className="text-lg font-semibold">Review</h2>
          <div className="p-4 bg-gray-800 rounded-md space-y-3">
            <div className="p-3 bg-gray-700 rounded-md review-card">
              <h3 className="font-bold text-indigo-300">Summary</h3>
              <p className="text-gray-300">{review.summary}</p>
            </div>
            <div className="p-3 bg-gray-700 rounded-md review-card">
              <h3 className="font-bold text-indigo-300">Critique</h3>
              <p className="text-gray-300">{review.critique}</p>
            </div>
            <div className="p-3 bg-gray-700 rounded-md review-card">
              <h3 className="font-bold text-indigo-300">Suggestions</h3>
              <p className="text-gray-300">{review.suggestions}</p>
            </div>
          </div>
        </div>
      );

      const ProductionRiskSection = ({ risks }) => (
        <div className="space-y-4 pt-4 border-t border-gray-700">
          <h2 className="text-lg font-semibold">Production Risk Watch</h2>
          <ul className="p-4 bg-gray-800 rounded-md space-y-2">
            {risks.map((item, index) => (
              <li key={index} className="flex items-start">
                <span className="mr-2">{item.isSafe ? "‚úÖ" : "‚ö†Ô∏è"}</span>
                <span>{item.risk}</span>
              </li>
            ))}
          </ul>
        </div>
      );

      const DocstringSection = ({ docstring }) => (
        <div className="space-y-4 pt-4 border-t border-gray-700">
          <h2 className="text-lg font-semibold">Generated Docstring</h2>
          <div className="p-4 bg-gray-800 rounded-md">
            <pre className="text-gray-300 whitespace-pre-wrap font-mono text-sm">
              <code>{docstring}</code>
            </pre>
          </div>
        </div>
      );
      
      function App() {
        const [code, setCode] = React.useState("");
        const [review, setReview] = React.useState(null);
        const [productionRisk, setProductionRisk] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(false);
        const [loadingMessage, setLoadingMessage] = React.useState(
          "Your code review will appear here..."
        );
        const [docstring, setDocstring] = React.useState("");
        const [activeTask, setActiveTask] = React.useState("");
        const [apiKey, setApiKey] = React.useState("");
        
        // Auto review settings
        const [autoReviewEnabled, setAutoReviewEnabled] = React.useState(true);
        const [reviewThreshold, setReviewThreshold] = React.useState("medium");
        const [commitAssistEnabled, setCommitAssistEnabled] = React.useState(true);
        
        React.useEffect(() => {
          const handleMessage = (event) => {
            const message = event.data;
            switch (message.command) {
              case "displayReview":
                setReview(message.review);
                setProductionRisk(message.productionRisk || []);
                setIsLoading(false);
                break;
              case "displayDocstring":
                setDocstring(message.docstring);
                setIsLoading(false);
                break;
              case "setApiKey":
                setApiKey(message.apiKey || "");
                break;
              case "setAutoReviewSettings":
                setAutoReviewEnabled(message.autoReviewEnabled ?? true);
                setReviewThreshold(message.reviewThreshold || "medium");
                setCommitAssistEnabled(message.commitAssistEnabled ?? true);
                break;
            }
          };
          window.addEventListener("message", handleMessage);
          vscode.postMessage({ command: "getApiKey" });
          vscode.postMessage({ command: "getAutoReviewSettings" });
          return () => window.removeEventListener("message", handleMessage);
        }, []);

        React.useEffect(() => {
          let interval;
          if (isLoading) {
            const messages = [
              "Sending code to the AI...",
              "Waking up the reviewer...",
              "The AI is thinking...",
              "Analyzing for production risks...",
              "Formatting the response...",
              "Almost there...",
            ];
            let messageIndex = 0;
            setLoadingMessage(messages[messageIndex]);
            interval = setInterval(() => {
              messageIndex = (messageIndex + 1) % messages.length;
              setLoadingMessage(messages[messageIndex]);
            }, 2000);
          } else {
            setLoadingMessage("Your code review will appear here...");
          }
          return () => clearInterval(interval);
        }, [isLoading]);

        const handleReviewClick = () => {
          setIsLoading(true);
          setActiveTask("review");
          setReview(null);
          setProductionRisk([]);
          setDocstring("");
          vscode.postMessage({ command: "review", code });
        };

        const handleGenerateDocstringClick = () => {
          setIsLoading(true);
          setActiveTask("docstring");
          setReview(null);
          setProductionRisk([]);
          setDocstring("");
          vscode.postMessage({ command: "generateDocstring", code });
        };
        
        const handleCopyClick = () => {
          if (!review) return;
          let md = `## CodeCritter Review (via ${persona})\n\n### Summary\n> ${review.summary}\n\n### Critique\n> ${review.critique}\n\n### Suggestions\n> ${review.suggestions}\n\n`;
          if (productionRisk.length > 0) {
            md += `### üö® Production Risk Watch\n`;
            productionRisk.forEach((item) => {
              md += `- ${item.isSafe ? "‚úÖ" : "‚ö†Ô∏è"} ${item.risk}\n`;
            });
          }
          vscode.postMessage({ command: "copyToClipboard", text: md });
        };

        const handleSaveKey = () => {
          vscode.postMessage({ command: "saveApiKey", apiKey: apiKey });
        };

        const handleSaveSettings = () => {
          vscode.postMessage({ 
            command: "saveAutoReviewSettings", 
            autoReviewEnabled,
            reviewThreshold,
            commitAssistEnabled,
          });
        };

        return (
          <div className="p-4 space-y-6">
            <Header />
            
            {/* Auto Review Status Banner */}
            <div className={`p-3 rounded-md border-l-4 ${
              autoReviewEnabled 
                ? 'bg-green-900/30 border-green-500' 
                : 'bg-gray-800 border-gray-500'
            }`}>
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium">
                    {autoReviewEnabled ? 'ü§ñ Auto Review Active' : 'üò¥ Auto Review Disabled'}
                  </p>
                  <p className="text-xs text-gray-400">
                    {autoReviewEnabled 
                      ? `Watching files ‚Ä¢ Threshold: ${reviewThreshold} ‚Ä¢ Commit assist: ${commitAssistEnabled ? 'on' : 'off'}`
                      : 'Enable in Auto Review Settings below'
                    }
                  </p>
                </div>
                <button 
                  onClick={() => setAutoReviewEnabled(!autoReviewEnabled)}
                  className="text-xs bg-indigo-600 hover:bg-indigo-700 px-2 py-1 rounded"
                >
                  {autoReviewEnabled ? 'Disable' : 'Enable'}
                </button>
              </div>
            </div>

            <CodeInput code={code} setCode={setCode} isLoading={isLoading} />

            <div className="flex space-x-2">
              <button
                className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors disabled:bg-gray-500"
                onClick={handleReviewClick}
                disabled={isLoading}
              >
                {isLoading && activeTask === "review"
                  ? "Getting Review..."
                  : "Get Manual Review"}
              </button>
              <button
                className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors disabled:bg-gray-500"
                onClick={handleGenerateDocstringClick}
                disabled={isLoading}
              >
                {isLoading && activeTask === "docstring"
                  ? "Generating..."
                  : "Generate Docstring"}
              </button>
            </div>

            {review && <ReviewSection review={review} />}
            {productionRisk.length > 0 && (
              <ProductionRiskSection risks={productionRisk} />
            )}
            {docstring && <DocstringSection docstring={docstring} />}

            {review && (
              <div className="pt-4 border-t border-gray-700">
                <button
                  className="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
                  onClick={handleCopyClick}
                >
                  Copy Review as Markdown
                </button>
              </div>
            )}
            
            {!review && !docstring && !isLoading && (
              <div className="space-y-4 pt-4 border-t border-gray-700 text-center">
                <p className="text-gray-400 italic">
                  {autoReviewEnabled 
                    ? "Auto review is active! Save any code file to get automatic analysis."
                    : "Your code review will appear here..."
                  }
                </p>
              </div>
            )}
            {isLoading && (
              <div className="space-y-4 pt-4 border-t border-gray-700 text-center">
                <p className="text-gray-400 italic">
                  <span className="inline-block border-r-2 border-transparent blinking-cursor pr-1">
                    {loadingMessage}
                  </span>
                </p>
              </div>
            )}

            <AutoReviewSection 
              autoReviewEnabled={autoReviewEnabled}
              setAutoReviewEnabled={setAutoReviewEnabled}
              reviewThreshold={reviewThreshold}
              setReviewThreshold={setReviewThreshold}
              commitAssistEnabled={commitAssistEnabled}
              setCommitAssistEnabled={setCommitAssistEnabled}
              handleSaveSettings={handleSaveSettings}
            />

            <SettingsSection
              apiKey={apiKey}
              setApiKey={setApiKey}
              handleSaveKey={handleSaveKey}
            />
          </div>
        );
      }

      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>